<dialog class="modal" open>
  <div class="modal-box w-5/6 max-w-3xl">
    <button
      class="btn btn-md btn-circle btn-ghost absolute right-4 top-4"
      (click)="handleCloseClick()"
    >
      âœ•
    </button>
    <!-- Header -->
    <div class="flex mb-6">
      <h3 class="text-xl font-bold text-nowrap">Extract frames</h3>
      <ul class="steps text-sm">
        <li class="step step-primary">Select a label file</li>
        <li class="step" [class.step-primary]="step() !== 'labelFile'">
          Select a session
        </li>
        <li class="step" [class.step-primary]="step() === 'settings'">
          Select extraction strategy
        </li>
      </ul>
    </div>

    <!-- Body -->
    @if (step() === "labelFile") {
      <div class="prose max-w-none!">
        <p class="mb-4 text-sm">
          This workflow identifies new frames to label and adds them to the
          labeling queue. It is often used when starting a project or to add
          frames from new sessions.
        </p>
        <div
          class="collapse collapse-plus text-sm bg-base-200 border-base-300 border mb-4"
        >
          <input type="checkbox" />
          <div class="collapse-title font-semibold">
            Where are extracted frames stored?
          </div>
          <div class="collapse-content text-sm">
            Extracted frames are stored as <code class="code">PNG</code> files
            in the <code class="code">labeled-data</code> subdirectory of the
            project data directory as follows
            <code class="code block p-2 m-2 bg-base-300"
              >&lt;data_dir&gt;&nbsp;/&nbsp;labeled-data&nbsp;/&nbsp;&lt;session_name&gt;&nbsp;/&nbsp;img&lt;frame_index&gt;.png</code
            >
            Additionally, for each frame <code class="code">i</code>, adjacent
            frames <code class="code">i-2 ... i+2</code> are extracted but not
            added to the labeling queue. These <b>context frames</b> are used to
            power some lightning pose features that help resolve occlusions.
          </div>
        </div>
        <div class="divider"></div>
        <div>
          <h3 class="text-md">Label file</h3>
          <fieldset>
            <legend>1. Select the destination for frame extraction</legend>
            <div class="m-4">
              <input
                class="radio mr-2"
                type="radio"
                name="labelFile"
                id="radio_createNew"
                value="createNew"
                [(ngModel)]="labelFileSelectionType"
              />
              <label for="radio_createNew">New label file</label><br />
              <input
                class="radio mr-2"
                type="radio"
                name="labelFile"
                id="radio_useExisting"
                value="useExisting"
                [(ngModel)]="labelFileSelectionType"
              />
              <label for="radio_useExisting">Existing label file</label>
            </div>
            @if (labelFileSelectionType() === "createNew") {
              <div class="mt-4">
                <label for="input_labelFileTemplate" class="mb-2"
                  >2. Enter the filename for the new label file</label
                >
                <div class="m-4">
                  <p class="text-sm">
                    @if (!isMultiviewProject()) {
                      Single camera project detected. If instead you have
                      multiple camera views for each session, set the Views
                      field in the project settings and return to this workflow.
                    } @else {
                      Multiview project detected. One file will be created per
                      camera view. Use the
                      <code class="p-1">*</code> character to represent the view
                      name. For example,
                      <code class="p-1">CollectedData_*.csv</code>.
                    }
                  </p>
                  <label
                    class="input"
                    [class.input-success]="
                      labelFileTemplateNgModel.valid &&
                      labelFileTemplateNgModel.touched
                    "
                    [class.input-error]="
                      labelFileTemplateNgModel.invalid &&
                      labelFileTemplateNgModel.touched
                    "
                  >
                    <input
                      type="text"
                      spellcheck="false"
                      id="input_labelFileTemplate"
                      [(ngModel)]="newLabelFileTemplate"
                      required
                      appLabelFileTemplateValidator
                      #labelFileTemplateNgModel="ngModel"
                    />
                    <span class="label">.csv</span>
                  </label>
                  <div class="validator-hint visible!">
                    <code>{{ defaultLabelFileTemplate() }}</code>
                    is the recommended default.
                  </div>
                  <div class="validator-hint visible! text-error min-h-[10rem]">
                    <ul>
                      @if (labelFileTemplateNgModel.errors?.["required"]) {
                        <li>Filename required</li>
                      }
                      @if (
                        labelFileTemplateNgModel.errors?.["invalidFilename"]
                      ) {
                        <li>Filename invalid</li>
                      }
                      @if (
                        labelFileTemplateNgModel.errors?.["viewStarMissing"]
                      ) {
                        <li>Filename missing required star character</li>
                      }
                      @if (
                        labelFileTemplateNgModel.errors?.[
                          "starNotNextToDelimiter"
                        ]
                      ) {
                        <li>
                          Star character must be next to valid delimiters: - or
                          _
                        </li>
                      }
                      @if (labelFileTemplateNgModel.errors?.["hasCSV"]) {
                        <li>
                          Invalid name: remove <code>.csv</code> extension
                        </li>
                      }
                    </ul>
                  </div>
                </div>
              </div>
            } @else if (labelFileSelectionType() === "useExisting") {
              <div class="mt-4">
                <label for="input_labelFileTemplate" class="mb-2"
                  >2. Select the destination label file</label
                >
                <app-label-file-picker
                  class="block m-4"
                  [(labelFileKey)]="existingLabelFileKey"
                  [selectSizeClass]="'select-md'"
                ></app-label-file-picker>
              </div>
            }
          </fieldset>
        </div>
      </div>
    } @else if (step() === "session") {
      <div>
        <sub class="text-sm block">Select a session to extract frames from</sub>

        <div class="p-4 flex items-center">
          <app-sessions-panel
            class="flex-1 min-w-0 max-h-70 overflow-clip"
            [showModelAvailableMarkers]="false"
            [selectedSessionKey]="session()?.key"
            (selectedSessionChange)="handleSelectedSessionChange($event)"
          ></app-sessions-panel>
          <div class="divider divider-horizontal">OR</div>
          <div class="flex-1 min-w-0 flex justify-center">
            <button class="btn tooltip" data-tip="Upload local video files to create a new session" (click)="sessionImportOpen.set(true)">
              Upload a new session
            </button>
          </div>
        </div>
      </div>
    } @else {
      <div>
        <sub class="text-sm">Choose which frames to extract.</sub>
        <div class="p-4">
          <div class="flex gap-1">
            <input
              [disabled]="isProcessing()"
              type="radio"
              name="extraction-strategy"
              id="radio-auto"
              value="auto"
              class="radio radio-sm"
              checked="checked"
            />
            <label for="radio-auto" class="text-sm">Auto</label>
          </div>
        </div>
        <div role="alert" class="alert text-sm">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            class="stroke-info h-6 w-6 shrink-0"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <span>
            Frames will be selected automatically across a diversity of frames,
            using motion energy and PCA.</span
          >
        </div>
      </div>

      <div class="mt-4">
        <p class="text-sm">
          Choose how many frames to extract. 20 is a good start, but extract as
          many or as little as you'd like.
        </p>
        <div class="p-4">
          <input
            [disabled]="isProcessing()"
            type="number"
            [(ngModel)]="nFrames"
            class="input validator"
            required
            placeholder="Enter a number"
            min="1"
            step="1"
          />
          <p class="validator-hint">Must be between be 1 to 10</p>
        </div>
      </div>
    }
    <!-- Footer -->
    <div class="flex justify-between mt-6 gap-2">
      @if (step() === "labelFile") {
        <button
          class="btn btn-outline btn-secondary"
          (click)="handleCloseClick()"
        >
          Cancel
        </button>
      } @else {
        <button
          class="btn btn-outline"
          [disabled]="isProcessing()"
          (click)="step.set(stepOrder[stepOrder.indexOf(step()) - 1])"
        >
          <span class="material-icons">arrow_back</span>Go back
        </button>
      }
      <div class="flex gap-2">
        @if (step() !== "settings") {
          <button
            class="btn btn-primary"
            [disabled]="!isNextEnabled() || isProcessing()"
            (click)="step.set(stepOrder[stepOrder.indexOf(step()) + 1])"
          >
            Continue
          </button>
        } @else {
          @if (isProcessing()) {
            <span class="loading loading-spinner loading-sm"></span>
          }
          <button
            [disabled]="!settingsStepIsValid() || isProcessing()"
            class="btn btn-soft btn-primary"
            (click)="handleExtractFramesClick()"
          >
            Extract frames
          </button>
        }
      </div>
    </div>
    @if (sessionImportOpen()) {
      <app-session-import (done)="onImportDone()"></app-session-import>
    }
  </div>
</dialog>
