<style>
  ::placeholder {
    /** bring back the default style from daisy. dont know why it's getting overridden. */
    color: color-mix(in oklch, currentColor 50%, #0000) !important;
  }
</style>

<div class="flex flex-col h-full">
  @if (!setupMode()) {
    <button
      class="btn btn-md btn-circle btn-ghost absolute right-4 top-4"
      (click)="closeButtonClick.emit(null)"
    >
      âœ•
    </button>
  }
  <h3 class="text-xl font-bold mb-4 shrink-0">
    @if (!setupMode()) {
      Project settings
    } @else {
      Create project
    }
  </h3>

  <div class="flex gap-2 w-full grow shrink min-h-0">
    <ul class="menu min-w-40">
      @for (tab of tabs; track tab.key; let i = $index) {
        <li>
          <a
            [class.menu-active]="selectedTab() === tab.key"
            tabindex="0"
            (click)="handleTabClick(tab.key)"
            (keydown.enter)="handleTabClick(tab.key)"
          >
            <span class="material-icons text-sm!">{{ tab.icon }}</span
            >{{ tab.text }}</a
          >
        </li>
      }
    </ul>
    <div class="divider divider-vertical"></div>
    <div class="overflow-y-auto w-full">
      @if (selectedTab() === "directories") {
        <form [formGroup]="directoriesForm" class="prose px-4">
          <p class="m-0! text-sm">
            Settings specific to this machine, stored in
            <code>~/.lightning-pose/projects.toml</code>
          </p>
          @if (setupMode()) {
            <fieldset class="fieldset">
              <h3 class="text-md">Project Name</h3>
              <p class="m-0!">The unique name used to identify this project.</p>
              <div class="input w-full">
                <span class="material-icons !text-sm opacity-50"
                  >description</span
                >
                <input
                  formControlName="projectKey"
                  type="text"
                  class="grow"
                  placeholder="Enter Project Name (e.g., MyMouseTrackingStudy)"
                  spellcheck="false"
                />
              </div>
              @if (
                directoriesForm.controls["projectKey"].invalid &&
                directoriesForm.controls["projectKey"].touched
              ) {
                <p class="text-error text-xs">Project name is required.</p>
              }
            </fieldset>
          }
          <fieldset class="fieldset">
            <h3 class="text-md">Data directory</h3>
            <p class="m-0!">
              The root of the data directory. Contains all data used to train
              models, and the <code>project.yaml</code> metadata file. The
              directory will be created if it doesn't exist.
            </p>
            <p class="m-0!">
              A good convention is
              <code>/ HOME_DIR / LPProjects / PROJECT_NAME</code>
            </p>

            <div class="input w-full">
              <span class="material-icons !text-sm opacity-50">folder</span>
              <input
                formControlName="dataDir"
                type="text"
                class="grow"
                placeholder="/"
                spellcheck="false"
              />
            </div>
            @if (
              directoriesForm.controls["dataDir"].invalid &&
              directoriesForm.controls["dataDir"].touched
            ) {
              <p class="text-error text-xs">Data directory is required.</p>
            }
          </fieldset>

          <fieldset class="fieldset">
            <h3 class="text-md">Model directory</h3>
            <p class="m-0!">The directory containing the project's models.</p>

            <div class="flex gap-2">
              <input
                type="checkbox"
                class="checkbox"
                formControlName="useDefaultModelDir"
              />
              <span class="m-0!">
                Use the default model directory:<br />
                <div class="inline-block w-4"></div>
                <code>/ DATA_DIR&nbsp;/&nbsp;models&nbsp;/</code>
              </span>
            </div>

            <div class="input w-full">
              <span class="material-icons !text-sm opacity-50">folder</span>
              <input
                formControlName="modelDir"
                type="text"
                class="grow"
                placeholder="/"
                spellcheck="false"
              />
            </div>
          </fieldset>
        </form>
      }
      @if (selectedTab() === "keypoints") {
        <form [formGroup]="keypointsForm" class="prose px-4 w-full">
          <fieldset class="fieldset my-6">
            <h3 class="text-md mt-0!">Keypoint names</h3>
            <p class="m-0!">
              Enter the names of the keypoints to label. This is also the
              labeling order of the keypoints.
            </p>
            <textarea
              class="textarea w-full"
              [rows]="keypointInitialRows()"
              formControlName="keypointNames"
              spellcheck="false"
            ></textarea>
            <p>
              Parsed:
              {{
                parseTextAsList(keypointsForm.controls["keypointNames"].value)
                  | json
              }}
            </p>
          </fieldset>
        </form>
      }
      @if (selectedTab() === "multiview") {
        <form [formGroup]="multiviewForm" class="prose px-4 w-full">
          <fieldset class="fieldset my-6">
            <h3 class="text-md mt-0!">Camera view names</h3>
            <p class="m-0!">
              Enter the names of the camera views, or
              <em>leave blank if this is a single view project.</em>
            </p>
            <p class="m-0!">
              Used to group multiview files. Sessions are identified by removing
              the view name from the video filename. Label CSV files are
              similarly grouped.
            </p>
            <p class="m-0!">
              Filenames should embed the view name delimited by underscore or
              hyphen. For example,
              <code>video_01_front.mp4</code> or
              <code>video_01-front.mp4</code> are valid, but not
              <code>video_01front.mp4</code>.
            </p>
            <textarea
              class="textarea w-full"
              [rows]="viewsInitialRows()"
              [placeholder]="cameraViewPlaceholder"
              formControlName="views"
              spellcheck="false"
            ></textarea>
            <p>
              Parsed:
              {{
                parseTextAsList(multiviewForm.controls["views"].value) | json
              }}
            </p>
          </fieldset>
        </form>
      }
    </div>
  </div>
  <footer class="shrink-0 modal-action">
    <p class="text-sm text-info">{{ saveSuccessMessage() }}</p>

    <div>
      <ng-template #nextButtonTemplate>
        <button
          class="btn btn-soft btn-primary"
          (click)="handleNextClick()"
          [disabled]="
            (selectedTab() === 'directories' && !isDirectoriesFormValid()) ||
            (selectedTab() === 'keypoints' && !isKeypointsFormValid()) ||
            (selectedTab() === 'multiview' && !isMultiviewFormValid())
          "
        >
          Next
        </button>
      </ng-template>

      <ng-template #saveButtonTemplate>
        <button
          class="btn btn-soft btn-primary"
          (click)="handleSaveClick()"
          [disabled]="!projectInfoForm.dirty"
        >
          Save
        </button>
      </ng-template>

      @if (setupMode()) {
        <!-- Create: next until the last tab, then save -->
        @if (selectedTabIndex() < tabs.length - 1) {
          <ng-container *ngTemplateOutlet="nextButtonTemplate"></ng-container>
        } @else {
          <ng-container *ngTemplateOutlet="saveButtonTemplate"></ng-container>
        }
      } @else {
        <!-- Edit: always a save button -->
        <ng-container *ngTemplateOutlet="saveButtonTemplate"></ng-container>
      }
    </div>
  </footer>
</div>
